##    Mysql Migration Manager

Mysql Migration Manager - программа, написанная на PHP, которая позволяет __автоматически__ создавать миграции 
структуры базы данных и управлять ими.
Вы можете разворачивать созданные другими пользователями миграции на вашей локальной машине либо на удаленном сервере, 
поддерживая таким образом базу в актуальном состоянии. Это полезно в условиях реальной работы множества разработчиков, 
когда постоянно возникает необходимость создания новых таблиц, изменения колонок, добавления триггеров и прочих 
сущностей в БД.
Обратите внимание, что этот способ не связан с созданием миграций в фреймворках, таких как Yii, когда программист сам 
должен описать желаемые правки в структуре данных, а скорее ближе к автоматическому созданию миграций в Doctrine, 
но может покрывать некоторые дополнительные нюансы работы с изменениями структуры данных в MySQL. 

В условиях активной разработки на production-сервере БД может ежедневно вноситься немалое количество изменений. В этом
случае можно рассмотреть возможность выделить ответственного за процесс создания миграций, поручить это DBA или сделать
автоматизированное создание. Затем миграции можно хранить в системе контроля версий, копию файлов из которой каждый 
разработчик сможет получить на своем локальном ПК и развернуть. Для упрощения описания механизма работы введем  
следующие термины:

1. Эталонная БД. Это БД, расположенная на production-сервере. Именно с нее снимается начальный слепок схемы данных, и 
именно к идентичному ей состоянию должна быть приведена структура БД на локальных машинах разработчиков
2. Временная БД. Это БД, расположенная на локальной машине лица, создающего новые миграции, либо на локальной машине 
разработчика или в целом любого окружения, где необходимо, не имея точных сведений о состоянии локальной БД, привести 
ее к состоянию, идентичному эталонной БД. Временная БД может иметь статичное имя, либо ее может генерироваться на 
основе текущего времени и префикса
3. MMM - непосредственно сокращение от Mysql Migration Manager. Фактически эта программа является фронтендом к форку 
[mysqldiff](https://github.com/vitaliy-evsyukov/mysqldiff), программы на Perl. Об ее установке будет рассказано ниже

Таким образом, процесс работы может быть построен следующим образом:

- автоматически или вручную снимается миграция, в это время *никаких* операций со структурой данных в БД не должно 
происходить, равно как и на втором этапе
- для проверки корректности миграции следут сразу же после снятия повторить попытку создания, если создастся еще одна
миграция, это скажет о том, что обнаружен дефект в mysqldiff, который не позволил создать миграцию с таким содержимым, 
что его однократное применение приведет к идентичности БД на production-сервере и на сервере, где создается временная 
БД, используемая для сравнения с эталонной
- на машине разработчика либо на машине, где требуется развернуть БД с идентичной эталонной БД структурой, выполняется 
очередная полученная миграция или форсированное приведение к эталонной структуре

Обращаю ваше внимание, что:

- команда upgrade в большинстве случаев должна выполняться однократно, после разворачивания дампа БД, который могут 
предоставить для начальной работы, либо в том случае, если отсутствует или утеряна информация о последней примененной 
миграции
- команда migrate должна выполняться каждый раз, когда получена новая миграция или их набор (если в течение некоторого 
периода обновления не проводились, но информация о последней примененной миграции сохранена)
- команда deploy должна выполняться только если стоит задача разворачивания тестовой БД с данными
(для отладки или для создания некоторой песочницы)
- команда init должна выполняться только на тех данных, которые не представляют ценности, так как удаляет все таблицы 
из базы и создает пустые таблицы из схемы

### Настройка окружения БД

Для работы c МММ удобнее всего создать нового пользователя БД. Для упрощения настройки вы можете выдать ему 
все привилегии. Однако, если необходимо, чтобы пользователь имел только реально необходимые ему полномочия, вот они:

- Для основой БД, с которой будут сниматься миграции и/или на которую они будут накладываться: 
`CREATE, DROP, LOCK TABLES, ALTER, DELETE, INDEX, INSERT, UPDATE, SELECT, UPDATE, TRIGGER, 
CREATE VIEW, SHOW VIEW, ALTER ROUTINE, CREATE ROUTINE, EXECUTE, SHOW DATABASES`
- Для БД mysql: право `SELECT` на `mysql.proc`
- Для временной БД: все привилегии

В примере далее будем считать, что мы устанавливаем все полномочия. Также примем за данность, что наша локальная база
называется `main_db`, эталонная - `production_main_db`, а временная БД - `mmm_tmp`.

Выполните на локальном сервере БД следующие операторы (вместо pass следует использовать более безопасный пароль):

```sql
CREATE USER 'mmm-user'@'%' IDENTIFIED BY 'pass';
GRANT ALL PRIVILEGES ON mmm_tmp.* TO 'mmm-user'@'%';
GRANT ALL PRIVILEGES ON main_db.* TO 'mmm-user'@'%';
GRANT SELECT ON mysq.proc TO 'mmm-user'@'%';
```

На боевом сервере БД выполните следуюшие операторы:

```sql
CREATE USER 'mmm-user'@'%' IDENTIFIED BY 'pass';
GRANT SELECT, LOCK TABLES, EXECUTE, SHOW VIEW, TRIGGER ON production_main_db.* TO 'mmm-user'@'%'
GRANT SELECT ON mysq.proc TO 'mmm-user'@'%';
```

В процессе работы MMM может появиться ошибка

    ERROR 1419 (HY000): You do not have the SUPER privilege and
    binary logging is enabled (you *might* want to use the less safe
    log_bin_trust_function_creators variable)
    
В этом случае выполните команду

```sql
SET GLOBAL log_bin_trust_function_creators = 1;
```