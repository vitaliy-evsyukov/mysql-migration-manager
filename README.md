##    Mysql Migration Manager

Mysql Migration Manager - программа, написанная на PHP, которая позволяет __автоматически__ создавать миграции 
структуры базы данных и управлять ими.
Вы можете разворачивать созданные другими пользователями миграции на вашей локальной машине либо на удаленном сервере, 
поддерживая таким образом базу в актуальном состоянии. Это полезно в условиях реальной работы множества разработчиков, 
когда постоянно возникает необходимость создания новых таблиц, изменения колонок, добавления триггеров и прочих 
сущностей в БД.
Обратите внимание, что этот способ не связан с созданием миграций в фреймворках, таких как Yii, когда программист сам 
должен описать желаемые правки в структуре данных, а скорее ближе к автоматическому созданию миграций в Doctrine, 
но может покрывать некоторые дополнительные нюансы работы с изменениями структуры данных в MySQL. 

В условиях активной разработки на production-сервере БД может ежедневно вноситься немалое количество изменений. В этом
случае можно рассмотреть возможность выделить ответственного за процесс создания миграций, поручить это DBA или сделать
автоматизированное создание. Затем миграции можно хранить в системе контроля версий, копию файлов из которой каждый 
разработчик сможет получить на своем локальном ПК и развернуть. Для упрощения описания механизма работы введем  
следующие термины:

1. Эталонная БД. Это БД, расположенная на production-сервере. Именно с нее снимается начальный слепок схемы данных, и 
именно к идентичному ей состоянию должна быть приведена структура БД на локальных машинах разработчиков
2. Временная БД. Это БД, расположенная на локальной машине лица, создающего новые миграции, либо на локальной машине 
разработчика или в целом любого окружения, где необходимо, не имея точных сведений о состоянии локальной БД, привести 
ее к состоянию, идентичному эталонной БД. Временная БД может иметь статичное имя, либо ее может генерироваться на 
основе текущего времени и префикса
3. MMM - непосредственно сокращение от Mysql Migration Manager. Фактически эта программа является фронтендом к форку 
[mysqldiff](https://github.com/vitaliy-evsyukov/mysqldiff), программы на Perl. Об ее установке будет рассказано ниже
4. Датасеты. Наборы данных находятся по умолчанию в папе datasets подмодуля data и лежат в подпапках, имена которых 
собственно и являются названиями датасетов. Внутри папки должен лежать файл с параметрами датасета в формате JSON 
и файл с SQL-командами для вставки данных.
5. SQL-файлы для построения схемы. Обычные SQL-файлы, лежащие в вашей schemadir и имеющие имена, соответствующие 
названиям таблиц, описания которых в них находятся. Один файл - одна таблица.


Таким образом, процесс работы может быть построен следующим образом:

- автоматически или вручную снимается миграция, в это время *никаких* операций со структурой данных в БД не должно 
происходить, равно как и на втором этапе
- для проверки корректности миграции следут сразу же после снятия повторить попытку создания, если создастся еще одна
миграция, это скажет о том, что обнаружен дефект в mysqldiff, который не позволил создать миграцию с таким содержимым, 
что его однократное применение приведет к идентичности БД на production-сервере и на сервере, где создается временная 
БД, используемая для сравнения с эталонной
- на машине разработчика либо на машине, где требуется развернуть БД с идентичной эталонной БД структурой, выполняется 
очередная полученная миграция или форсированное приведение к эталонной структуре

Обращаю ваше внимание, что:

- команда upgrade в большинстве случаев должна выполняться однократно, после разворачивания дампа БД, который могут 
предоставить для начальной работы, либо в том случае, если отсутствует или утеряна информация о последней примененной 
миграции
- команда migrate должна выполняться каждый раз, когда получена новая миграция или их набор (если в течение некоторого 
периода обновления не проводились, но информация о последней примененной миграции сохранена)
- команда deploy должна выполняться только если стоит задача разворачивания тестовой БД с данными
(для отладки или для создания некоторой песочницы)
- команда init должна выполняться только на тех данных, которые не представляют ценности, так как удаляет все таблицы 
из базы и создает пустые таблицы из схемы

### Настройка окружения

#### БД

Для работы c МММ удобнее всего создать нового пользователя БД. Для упрощения настройки вы можете выдать ему 
все привилегии. Однако, если необходимо, чтобы пользователь имел только реально необходимые ему полномочия, вот они:

- Для основой БД, с которой будут сниматься миграции и/или на которую они будут накладываться: 
`CREATE, DROP, LOCK TABLES, ALTER, DELETE, INDEX, INSERT, UPDATE, SELECT, UPDATE, TRIGGER, 
CREATE VIEW, SHOW VIEW, ALTER ROUTINE, CREATE ROUTINE, EXECUTE, SHOW DATABASES`
- Для БД mysql: право `SELECT` на `mysql.proc`
- Для временной БД: все привилегии

В примере далее будем считать, что мы устанавливаем все полномочия. Также примем за данность, что наша локальная база
называется `main_db`, эталонная - `production_main_db`, а временная БД - `mmm_tmp`.

Выполните на локальном сервере БД следующие операторы (вместо pass следует использовать более безопасный пароль):

```sql
CREATE USER 'mmm-user'@'%' IDENTIFIED BY 'pass';
GRANT ALL PRIVILEGES ON mmm_tmp.* TO 'mmm-user'@'%';
GRANT ALL PRIVILEGES ON main_db.* TO 'mmm-user'@'%';
GRANT SELECT ON mysq.proc TO 'mmm-user'@'%';
```

На боевом сервере БД выполните следуюшие операторы:

```sql
CREATE USER 'mmm-user'@'%' IDENTIFIED BY 'pass';
GRANT SELECT, LOCK TABLES, EXECUTE, SHOW VIEW, 
      TRIGGER ON production_main_db.* TO 'mmm-user'@'%'
GRANT SELECT ON mysq.proc TO 'mmm-user'@'%';
```

В процессе работы MMM может появиться ошибка

    ERROR 1419 (HY000): You do not have the SUPER privilege and
    binary logging is enabled (you *might* want to use the less safe
    log_bin_trust_function_creators variable)
    
В этом случае выполните команду

```sql
SET GLOBAL log_bin_trust_function_creators = 1;
```

#### mysqldiff

Программа mysqldiff написана на Perl, репозиторий с ней является подмодулем MMM. Вы можете самостоятельно склонировать 
его с помощью команды 

`git clone https://github.com/vitaliy-evsyukov/mysqldiff`

Однако более простым способом будет получение непосредственно подмодуля. В папке MMM выполните команды

    git submodule init
    git submodule update
    
В комплекте есть скрипты установки для Windows, Debian-like систем и MacOS. 

##### Установка для *nix

Ввиду некорректных изменений 
в процессе апгрейда от Fedora 15 до Fedora 16 (или в случае возникновения подобных проблем под другими ОС) можно 
использовать, отредактировав, файл install_fedora.sh. В нем параметр -I должен иметь значение, равное пути, по которому 
интерпретатор perl должен искать библиотеки. В моем случае я сталкивался со следующей проблемой:

    perl: symbol lookup error: /usr/local/lib/perl5/auto/version/vxs/vxs.so: undefined symbol: Perl_Gthr_key_ptr

В общем случае для установки необходимы:

- perl >= 5.006
- Module::Build
- Carp
- File::Slurp
- IO::File
- DBI
- DBD::mysql

Они должны установиться автоматически скриптом установщика, однако в случае возникновения проблем можно попробовать 
сделать это вручную с помощью команд:

    $ sudo cpan Module::Build && cpan Carp && cpan File::Slurp && cpan IO::File && cpan DBI && cpan DBD::mysql
    $ sudo apt-get install libmysqlclient-dev
    
Автоматическая установка для Debian-like систем производится путем запуска скрипта `install_windows_debian.sh`
    
Для установки при наличии Percona Server на Fedora вместо "штатного" mysql необходимо установить пакет 
Percona-Server-devel с помощью команды

    $ yum install Percona-Server-devel-55
    
##### Установка для Windows

Для установки под Windows (тестировалось на Windows 7 Ultimate x64) необходимо скачать пакет 
[ActivePerl](http://www.activestate.com/activeperl/downloads). Даже если у вас 64-разрядная ОС, необходимо установить 
x86 версию, поскольку на момент написания не существует способа установить MinGW "из коробки" для версии под 
64-разрядные ОС.После установки откройте Perl Package Manager, выберите в меню View пункт All Packages, найдите в 
списке и установите MinGW (для этого нужно щелкнуть правой кнопкой по MinGW, выбрать единственный пункт меню и 
выполнить `File -> Run marked actions...`). Затем перейдите в папку с исходными кодами mysqldiff и выполните команду 

    perl Build.PL
     
Если вы получите сообщение, что требуются зависимости, выполните 

    perl Build installdeps 
    
и затем снова 

    perl Build.PL
    
После этого выполните 

    perl Build
    perl Build install.

По умолчанию mysqldiff установится как `C:\Perl\site\bin\mysqldiff`.

##### Установка для MacOS

Используя штатный Perl:

    sudo cpan install Module::Build
    sudo cpan install Carp
    sudo cpan install File::Slurp
    sudo cpan install IO::File
    sudo cpan install DBI
    sudo cpan install DBD::mysql
    
Использя Brew: так же, но без `sudo`.

### Настройка MMM

МММ использует один файл конфига для одной базы данных. Скопируйте дефолтный файл `config.ini.tpl` с другим именем. 
Удобной практикой будет создание конфигов с именем БД в названии, например, `config_main_db.ini`. По умолчанию будет 
использован файл конфига с именем `config.ini`. Это поведение может быть изменено путем передачи опции `config` в 
командной строке со значением в виде пути к желаемому конфигурационному файлу.

Все указанные в конфиге настройки могут быть перекрыты опциями с такими же именем, кроме опций из секции `replace`.
Ниже будет приведен пример файла конфига, а описание опций будет указано в виде `--<опция>`. 
В командной строке опции следует передавать в формате `--<опция>=<значение>`. 

#### Пример конфига

```ini
[main]
host=production.server.com
user=mmm-user
password=pass
db=production_main_db
cachedir=main_db_data/cache
savedir=main_db_data/migrations
datasetsdir=main_db_data/datasets
schemadir=sotm-db-data/schema
reqtables=tables.json
reqdata=data.sql
routine_user=`root`@`%`
versionfile=revisions.txt
version_marker=marker.txt
verbose=3
mysqldiff_command="mysqldiff --logs-folder=/var/log/mysqldiff"

[tmpdb]
tmp_db_name=mmm_tmp
tmp_add_suffix=0
tmp_host=localhost
tmp_user=mmm-user
tmp_password=pass
```

Данный конфиг может быть использован для съема миграций, однако для применения их на локальной БД достаточно лишь 
изменить данные подключения и имя базы на локальные.

#### Описание параметров

Секция `main` предназначеня для описания основных параметров:

     --host                  Имя хоста сервера БД
     --user                  Имя пользователя
     --password              Пароль
     --port                  Порт подключения к БД, по умолчанию 3306
     --db                    Название БД
     --savedir               Путь к директории, в которой будут сохраняться 
                             файлы миграций
     --cachedir              Путь к директории, в которой будут сохраняться файлы схем
     --datasetsdir           Путь к директории с наборами данных
     --schemadir             Путь к директории с начальными описаниями таблиц
     --reqtables             Файл в формате JSON, в котором хранится 
                             список нужных для набора данных таблиц
     --reqdata               Файл с SQL-командами для набора таблиц
     --versionfile           Файл, в котором будет храниться информация о миграциях
     --version_marker        Файл, в которой хранится информация о последней 
                             примененной миграции
     --mysqldiff_command     Команда для запуска mysqldiff. Должна содержать параметр 
                             с путем к логам (--logs-folder). По умолчанию логи будут 
                             созданы в папке, в которую установлен mysqldiff, и у 
                             текущего пользователя может не быть прав на запись в нее
     --verbose               Уровень отладки. 
                             Отладочные сообщения будут выводиться, только если он 
                             больше либо равен уровню, с которым выводится 
                             отладочное сообщение
     --quiet                 Отключает вывод всех сообщений, за исключением ошибок
     --routine_user          Устанавливает пользователя, который будет использован как 
                             значение DEFINER у триггеров, хранимых процедур и функций
                             
В секции `tempdb` должны содержаться следующие значения:

     --tmp_add_suffix        Если значение кастуется к логической истине, то имена 
                             временных БД будуть заканчиваться суффиксом в виде 
                             метки времени UNIX. 
                             При апгрейде суффиксом имени будет само название временной 
                             БД, а начальной частью имени - строка 'full_temp_db_'
     --tmp_db_name           Имя временной БД, в которой будет производиться поиск 
                             связей и в которой будут разворачиваться миграции и 
                             схема для сравнения. Если tmp_add_suffix не указан или 
                             может быть приведен к логическому значению ЛОЖЬ, то к 
                             имени не будет ничего добавлено, таким образом, вы 
                             обеспечите статичность имени временной БД. 
                             Это полезно, если ваши права на сервере БД ограничены, 
                             так как администратору БД необходимо будет выдать 
                             права только на две базы данных, оригинальную и временную
     --tmp_host              Хост, на котором будет развернута временная БД
     --tmp_user              Имя пользователя на этом хосте
     --tmp_password          Пароль пользователя на этом хосте
     --tmp_port              Порт БД на этом хосте
     
В секции `replace` конфигурация должна выглядеть следующим образом:

```ini
[replace]
database.production_main_db=main_db
database.some_another_production_db=some_local_db
```

Каждый элемент должен начинаться с подстроки `database.`, следующая часть имени значения - название БД, которую 
требуется заменить при нахождении в хранимых процедурах, функциях, триггерах, внешних ключах и т.п. Как правило, эту 
секцию можно опустить, однако, если в эталонной БД есть захардкоженное наименование ее названия или названия других 
баз данных, которых нет на локальной машине (напомним, в нашем примере аналогичная эталонной БД база 
названа `main_db`), при накатке миграций его нужно автоматически заменять. Эту цель и преследует данная опция. 

### Команды

Для запуска MMM убедитесь, что в переменной окружения Path прописан путь к PHP-интерпретатору. Однако можно запускать 
команду и непосредственно передавая на вход интерпретатору файл `migration.php`.

После установки вам требуется выполнить настройку MMM, отредактировав конфигурационный файл программы.
Краткую справку по программе вы можете получить, запустив программу с параметром help:

`php migration.php help`

#### Апгрейд существующей базы данных
Если у вас есть база данных, на которую никогда не накатывались миграции (либо вы не уверены, в каком состоянии 
находится эта база), вы наверняка захотите ввести ее в нормальный цикл работы с миграциями. 
Для этого вам необходимо сделать апгрейд, который выполнит накатку временной базы из существующих миграций, 
сравнит вашу базу со временной и выполнит одну "специальную" миграцию, которая приведет вашу БД к состоянию последней 
ревизии. Нужно обратить внимание, что в процессе накатывания миграции возможны ошибки как из-за имеющихся в вашей БД 
данных (например, таблица с неуникальными значениями в определнном поле в результате миграций должна получить 
уникальный индекс на это поле), так и ввиду возможных проблем с DDL. Все ошибки выводятся на экран по умолчанию.

Для выполнения апгрейда выполниет команду

`php migration.php upgrade`

Апгрейд, как правило, занимает продолжительное время. После окончания апгрейда вы можете просто мигрировать до новых 
миграций при появлении таких в репозитарии. По окончании апгрейда в вашем marker.txt будет номер последней ревизии.

#### Схема

`php migration.php schema`
При запуске этой команды без параметров MMM пройдется по вашей schemadir и сохранит содержимое файлов в "кеше" - файле 
схемы (Schema.class.php), после чего применит эти данные на нужной вам базе. Вы можете указать параметр 
`--datasets="список датасетов через запятую"`, чтобы получить схему только тех таблиц, которые описаны в нужном вам 
датасете. В этом случае имя файла схемы будет иметь вид `SchemaХЕШ.class.php`, где `ХЕШ` - md5 от конкатенированной 
отсортированной в алфавитном порядке последовательности имен датасетов.

##### Пример файла описания датасета

Файл, согласно нашему примерному конфигу, может находиться здесь: `main_db_data/datasets/main/tables.json`. Здесь 
`tables.json` - обязательное наименование файла, `main_db_data/datasets` - значение параметра `datasetsdir` из конфига, 
а `main` - собственно название датасета и при ином наименовании папки может будет равным этому наименованию.

```json
{
    "tables" : [
        "table1",
        "table2",
        "table3"
    ]
}
```

##### Пример данных датасета

Файл аналогично файлу описания датасета должен называться `data.sql` и должен находиться в 
`main_db_data/datasets/main/data.sql`. Его содержимым могут быть любые SQL-операторы (обычно `INSERT`'ы для собственно 
наполнения БД).

```sql
INSERT INTO table1 VALUES (1, 'a', 38.45);
INSERT INTO table3 VALUES (100, 1);
```

#### Снятие ревизии

`php migration.php create`

Эта команда не имеет параметров. Она исполнит `mysqldiff` и запишет изменения, которые он выдаст, в файле в нужном 
формате. Файлы имеют имена вида `MigrationНОМЕР.class.php`, где `НОМЕР` - идентификатор миграции. Все миграции 
записываются в файл, описываемый параметром `versionfile`. Если он утерян, то миграции не могут быть воспроизведены, 
поэтому для его восстановления используйте команду

`php migration.php recover`

Созданный файл ревизии следует по

#### Миграции
Когда вы имеете в распоряжении файлы миграций, вы можете откатиться до нужной миграции или же накатить миграции. 

`php migration.php migrate`

Без параметров эта команда накатит вам все миграции от текущей. Текущая миграция берется из файла, описываемого 
параметром `version_marker`. Если по каким-либо причинам это нужно изменить, используйте параметр 
`--revision="номер текущей миграции"`, либо напрямую изменить содержимое данного файла. Этот файл не следует 
отправлять в систему контроля версий, поскольку другим участникам не должно быть известно, с какой версией базы вы 
работаете.
Для указания точной миграции, к которой нужно перейти, используйте параметр `--m="число"`, в противном случае 
используйте значение этого параметра из списка тех, которые может принимать на вход php-функция `strtotime`.

Например, вы желаете накатить миграции с 3-ей по 27-ю. В таком случае выполните команду

`php migration.php migrate --revision=3 --m=27`

В случае, если вы хотите откатиться с текущей (к примеру, 190-й миграции, однако это не играет никакой роли) до 
более старой, например, 137-й, выполните

`php migration.php migrate --m=137`

Список миграций и текущую миграцию вы можете увидеть, выполнив команду

`php migration.php list`

#### Применение наборов данных

`php migration.php applyds --datasets="набор данных"`

Эта команда выполняет вставки данных из датасетов. Параметр `--datasets` должен быть указан обязательно.

#### Деплой

`php migration.php deploy`

Разворачивание выполнит следующие действия по порядку: создание и разворачивание схемы, миграции (до последней, 
если не указано иное) и разворачивание наборов данных. Будьте внимательны: 
__эта команда уничтожит все таблицы в вашей БД!__
Вы можете указать датасеты, которые нужно развернуть, и дать указания по поводу того, до какой миграции нужно обновить 
структуру БД.

#### Возврат к схеме

Иногда нужно выполнить возврат к схеме, которая была создана. Используйте для этого 

`php migration.php init`

Вы также можете указать, для каких датасетов будет развернута схема.

#### Проверка актуальности состояния локальной БД

Если вы хотите просто узнать, не выполняя никаких изменений в БД, насколько она отличается от эталонной, вы можете 
сделать это с помощью команды 

`php migration.php verify`

На экране появится набор полученных различий либо информация о том, что отличий не обнаружено.

#### Очистка

Для удаления временных баз данных, которые могли остаться, к примеру, после аварийного завершения работы,
используйте команду

`php migration.php gc`

Все временные БД будут удалены.